name: CI and Sync to Organizer

on:
  push:
    branches: [ "main" ]

jobs:
  ci-sync:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ ë‚´ ë ˆí¬ ì²´í¬ì•„ì›ƒ
      - name: Checkout my repository
        uses: actions/checkout@v4

      # 3ï¸âƒ£ SSH ì„¤ì • (Deploy Key)
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.ORGANIZER_DEPLOY_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan github.com >> ~/.ssh/known_hosts
          
      - name: Setup whoami
        run: |
          git config --global user.name "${{ github.actor }}"
          git config --global user.email "${{ github.actor }}@users.noreply.github.com"
          
      - name: Sync to organizer repository
        env:
          ORG_REPO: git@github.com:SKALA-Cloud-team-2/algorithm-study.git
          USERNAME: ${{ github.actor }}
        run: |
          git clone $ORG_REPO algorithm-study
          cd algorithm-study

          git fetch origin

          # remote branchë¡œ ì´ë™ ì—†ìœ¼ë©´ ë³µì‚¬
          if git show-ref --verify --quiet refs/remotes/origin/$BRANCH; then
            # originì— ì¡´ì¬í•˜ë©´ ê·¸ ë¸Œëœì¹˜ë¥¼ ê·¸ëŒ€ë¡œ ê°€ì ¸ì˜´
            git checkout -B $BRANCH origin/$BRANCH
          else
            # originì— ì—†ìœ¼ë©´ main ê¸°ì¤€ìœ¼ë¡œ ìƒˆ ë¸Œëœì¹˜ ìƒì„±
            git checkout -B $BRANCH main
            git push -u origin $BRANCH
          fi

          # ë‚´ í’€ì´ë§Œ ë³µì‚¬ (ì¶©ëŒ ë°©ì§€)
          mkdir -p solutions/$USERNAME
          
          # [ì „ì²´ ë™ê¸°í™” ì„¤ì •]
          rsync -av --delete \
            --exclude='.*' \
            --exclude='algorithm-study' \
            $GITHUB_WORKSPACE/ \
            solutions/$USERNAME/

          git add solutions/$USERNAME

          git commit -m "sync: update solutions from $USERNAME" || exit 0
          
          # ğŸ‘‡ [ìˆ˜ì •ë¨] --force ì˜µì…˜ ì¶”ê°€
          git push origin user/$USERNAME --force
