name: CI and Sync to Organizer

on:
  push:
    branches: [ "main" ]

jobs:
  ci-sync:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ 내 레포 체크아웃
      - name: Checkout my repository
        uses: actions/checkout@v4

      # 2️⃣ SSH 설정 (Deploy Key)
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.ORGANIZER_DEPLOY_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan github.com >> ~/.ssh/known_hosts

      # 3️⃣ Git 사용자 설정
      - name: Setup whoami
        run: |
          git config --global user.name "${{ github.actor }}"
          git config --global user.email "${{ github.actor }}@users.noreply.github.com"

      # 4️⃣ Organizer 레포로 Sync
      - name: Sync to organizer repository
        env:
          ORG_REPO: git@github.com:SKALA-Cloud-team-2/algorithm-study.git
          USERNAME: ${{ github.actor }}
        run: |
          git clone $ORG_REPO algorithm-study
          cd algorithm-study

          mkdir -p solutions/$USERNAME

          rsync -av --delete \
            --exclude='.*' \
            --exclude='algorithm-study' \
            $GITHUB_WORKSPACE/ \
            solutions/$USERNAME/

          git add solutions/$USERNAME
          git commit -m "sync: update solutions from $USERNAME" || exit 0

          # ⭐ 핵심: 로컬 브랜치 없이도 안전
          git push origin HEAD:user/$USERNAME --force
