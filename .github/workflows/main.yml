name: CI and Sync to Organizer

on:
  push:
    branches: [ "main" ]

jobs:
  ci-sync:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ 내 레포 체크아웃
      - name: Checkout my repository
        uses: actions/checkout@v4

      # 2️⃣ SSH 설정 (Deploy Key)
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          printf "%s\n" "${{ secrets.ORGANIZER_DEPLOY_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan github.com >> ~/.ssh/known_hosts

      # 3️⃣ Git 사용자 설정
      - name: Setup git user
        run: |
          git config --global user.name "${{ github.actor }}"
          git config --global user.email "${{ github.actor }}@users.noreply.github.com"

      # 4️⃣ organizer 레포로 동기화
      - name: Sync to organizer repository
        env:
          ORG_REPO: git@github.com:SKALA-Cloud-team-2/algorithm-study.git
          USERNAME: ${{ github.actor }}
        run: |
          git clone $ORG_REPO algorithm-study
          cd algorithm-study

          # 내 전용 브랜치
          git checkout -B user/$USERNAME
          git pull origin user/$USERNAME --rebase || true

          # 내 풀이만 복사 (.git 제외 필수)
          mkdir -p solutions/$USERNAME
          rsync -av --delete \
            --exclude='.git' \
            "$GITHUB_WORKSPACE/" \
            "solutions/$USERNAME/"

          git add solutions/$USERNAME
          git commit -m "sync: update solutions from $USERNAME" || exit 0
          git push origin user/$USERNAME
